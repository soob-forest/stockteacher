# CH-1: WebSocket ↔ OpenAI 스트리밍 연동 계획

## 목표
- WebSocket 채팅을 실제 OpenAI 스트리밍 응답으로 연결하고, 비용/시간 초과 시 사용자에게 안전하게 안내한다.
- 오류/비용 한계 상황에서 graceful degradation(축약 응답 또는 오류 메시지)을 제공한다.

## 범위
- 포함: WebSocket 서버/클라이언트 흐름, OpenAI 스트리밍 호출, 비용 상한/타임아웃 가드, 에러 메시지/재시도 UX.
- 제외: Vector 검색/RAG, Slack 연동, 알림 채널, 인증/권한 고도화(별도 이슈).

## 기능 요구사항
1) 스트리밍 연결
   - WebSocket 수신 메시지를 OpenAI 스트리밍 API에 전달, 청크 단위로 클라이언트에 push.
   - SSE 폴백 여부는 CH-3에서 결정하되, 코드 구조상 추가 가능한 인터페이스로 설계.
2) 비용/시간 가드
   - 요청당 비용 한도 초과 시 스트리밍 중단 후 사용자에게 “비용 상한 초과” 메시지 전송.
   - 응답 지연/타임아웃 시 “응답 지연” 메시지와 재시도 권고.
3) 문맥 구성
   - 리포트 요약/헤드라인 + 최근 N개(기본 10~20) 대화 히스토리를 프롬프트에 포함.
   - 세션별 캐시가 있다면 캐시 사용, 없으면 DB 조회.
4) 오류 처리
   - 유효하지 않은 입력/빈 메시지 → 즉시 에러 응답(JSON).
   - OpenAI 오류(429/5xx) → 재시도 1회 후 실패 시 에러 메시지.
   - 기타 예외 → 에러 메시지 + 서버 로그.

## 비기능 요구사항
- 응답 첫 청크 < 2초, 스트리밍 중 평균 10~20 tokens/s(가능한 한).
- API 키 누락/비용 상한 초과 시 서버가 죽지 않고 클라이언트에게 명시적 안내.
- 로그에 민감 정보(사용자 메시지 원문) 저장 금지; trace_id 포함.

## 설계 초안
- 서버(api/chat_service.py)
  - OpenAIClient.stream_chat 사용 시 비용 추정/상한 체크 추가, 초과 시 예외 발생 → WebSocket 에러 전송.
  - 스트리밍 제너레이터에서 비용 계산을 위해 usage 토큰 집계가 필요하면 각 청크 후크 또는 최종 usage 요청(가능한 경우) 고려.
  - 컨텍스트 구성: ReportSnapshot 요약 + 최근 20개 메시지(캐시 → DB 순).
  - 에러 매핑: Transient → 클라이언트에 “일시 오류” + 재시도 힌트, Permanent → “요청 실패” 안내.
- 클라이언트(web/hooks/useChatWebSocket.ts)
  - 스트리밍 중 “입력 중” 표시 유지, 에러/타임아웃 메시지 배너 표시.
  - 메시지 전송 시 비용 상한 초과/키 누락 등의 에러를 사용자에게 노출.

## 테크니컬 태스크
- [ ] OpenAIClient.stream_chat: 비용/시간 가드 추가, 예외 타입 정의/재사용.
- [ ] ChatService.handle_message: 스트리밍 호출 경로에 가드 적용, trace_id/메타 로깅.
- [ ] WebSocket 라우트(api/routes.py): 에러 매핑 통일(에러 코드/메시지).
- [ ] 프론트 훅(web/hooks/useChatWebSocket.ts): 에러 배너/지연 알림 처리, 전송 중 버튼 비활성/재시도 UI.
- [ ] 테스트: 스트리밍 성공/비용 초과/타임아웃/빈 메시지/429 재시도 시나리오(단위+통합).

## 리스크/완화
- OpenAI 스트리밍에서 토큰 사용량을 중간에 못 얻을 수 있음 → 사후 usage 조회 또는 토큰 추정으로 근사, 상한은 입력 길이+max_tokens 기반 사전 차단.
- Redis 미가용 시 캐시 미사용 → DB 조회로 폴백하고 성능 저하 감수.
- 방화벽/프록시로 WebSocket 차단 → CH-3에서 SSE 폴백 설계.

## 완료 기준
- Happy path: WebSocket으로 질문 전송 시 2초 내 첫 청크 수신, 전체 응답 정상 저장.
- 오류: 비용 상한 초과/타임아웃/429 시 사용자에게 명시적 메시지, 서버는 예외 로깅 후 계속 동작.
- 회귀: 기존 HTTP 폴링/채팅 API(REST) 경로에 영향 없음 또는 명시적 비활성 안내. 
