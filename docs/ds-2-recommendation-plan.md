# DS-2: 관련 리포트 추천(티커/키워드 교집합) 계획

## 목표
- 리포트 상세 화면에 최근 7일 내 같은 티커/유사 키워드 기반의 관련 리포트를 보여줘 후속 탐색을 유도한다.

## 범위
- 포함: 간단한 교집합 기반 추천, UI 카드 노출, 빈 상태 안내.
- 제외: Vector DB/RAG, 개인화 랭킹, CTR 피드백 반영(후속).

## 요구사항
1) 데이터 집합: 최근 7일 report_snapshot, 동일 티커 우선, 키워드 교집합(최소 1개)로 필터.
2) 수량: 최대 3개, 최근 게시 순.
3) UI: 상세 화면에 “관련 리포트” 섹션, 카드(티커/헤드라인/게시 시각/태그/감성 배지) 링크.
4) 빈 상태: “관련 리포트가 없습니다” 메시지.
5) 성능: 추가 쿼리 1회 이내, p95 < 200ms 목표.

## 태스크
- [x] API: 추천 조회 함수/엔드포인트 추가 (`GET /api/reports/{id}/related`), 키워드 교집합 + 티커 가중치 + 신선도 가중치.
- [x] UI: 관련 리포트 섹션/카드 컴포넌트 추가(로딩/빈/에러 상태 표시).
- [x] 테스트: 티커 동일/키워드 교집합 시 반환, 교집합 없을 때 빈 리스트, 최대 3개 제한.

## 리스크
- 키워드 품질 저하 시 관련도 낮을 수 있음 → 태그/티커 우선 정렬로 완화.
- 데이터 부족 시 빈 상태 빈번 → 메시지/온보딩으로 기대치 관리.

## Problem 1-Pager (Kickoff)
- 배경: DS-1 필터 확장 완료로 탐색성이 높아졌으나, 상세 화면에서 후속 탐색·교차 리딩 경로가 부족하다.
- 문제: 상세 뷰에서 사용자가 유사 리포트를 빠르게 찾지 못해 이탈한다. 추천이 없거나 품질이 낮으면 DS-1 필터를 반복 입력해야 한다.
- 목표: 최근 7일, 동일 티커 우선 + 키워드 교집합 최소 1개로 최대 3개 추천을 노출해 상세 → 다른 리포트 전환률을 높인다. 응답 p95 <200ms 유지.
- 비목표: Vector/RAG 추천, 개인화 랭킹, CTR 학습, UI 재디자인 전면 교체.
- 제약: 함수 ≤50LOC, 파일 ≤300LOC, SQLite/PG 모두 동작, 외부 네트워크 호출 없음, 하드코딩 임계/가중치는 상수로 분리.

## 대안 비교 (API/랭킹 경로)
- Option A: DB 쿼리 조인 기반 (티커=우선, 키워드 교집합 필터 후 published_at DESC)
  - 장점: 단일 DB 쿼리, 의존성 없음, p95 관리 용이
  - 단점: 키워드 교집합 계산을 애플리케이션에서 후처리해야 할 수 있음(SQLite/PG JSON 차이)
  - 위험: 키워드 적은 리포트는 추천 공백
- Option B: 키워드 교집합 스코어 정렬(교집합 개수 → 티커 동일 여부) 후 상위 3개
  - 장점: 간단한 랭킹으로 품질 향상, DB 호환성 확보(후처리)
  - 단점: 애플리케이션 측 필터/정렬로 CPU 부담 증가 가능
  - 위험: 대량 데이터 시 메모리 사용 증가(현재 데이터셋에서는 제한적)
- Option C: Vector/RAG로 전환(후속)
  - 장점: 품질↑, DS-3와 일관된 파이프라인
  - 단점: 인프라/복잡도 증가, 범위 외

선택: Option B를 1차 채택 — DB에서 날짜/티커 범위를 제한한 뒤, 애플리케이션에서 키워드 교집합 스코어 + 티커 동일 가중치로 정렬하여 상위 3개를 반환한다. SQLite/PG 모두 동일 로직이 가능하며, 성능 리스크는 날짜 윈도우(최근 7일)로 완화한다.

## 실행 계획 (스프린트 단위)
- API
  - [x] `api/repositories.py`: 기준 insight_id와 동일 티커 우선 → 최근 7일 내 후보 조회 → 키워드 교집합 스코어링(교집합 개수 + 티커 동일 가중치 + 신선도) → 상위 3개 반환 함수 추가.
  - [x] `api/routes.py`: `/api/reports/{id}/related` 신설(캐싱 포함).
  - [x] 상수 정의: 추천 제한/윈도우/티커·신선도 가중치/캐시 TTL 환경 변수화.
- UI
  - [x] 상세 페이지(`web/app/reports/[insightId]/page.tsx`): "관련 리포트" 섹션 추가, 카드(티커/헤드라인/게시 시각/감성/태그) 및 빈 상태 메시지.
  - [x] 오류/빈 상태 시 사용자 안내 배지 표시, 로딩 스켈레톤 추가.
- 테스트
  - [x] API 단위: 동일 티커/키워드 교집합 시 반환, 교집합 없을 때 빈 배열, 3개 초과 시 절단.
  - [ ] UI 스냅샷: 카드 렌더링/빈 상태/에러 배너 확인.
- 관찰성/운영
  - [x] 추천 쿼리 latency/row count 로그 추가.
  - [x] 뒤로 호환: 추천 실패 시 무시하고 상세 본문은 그대로 제공(에러 배지 후 본문 노출 유지).

## 설정
- `RELATED_MAX_RESULTS` (기본 3)
- `RELATED_WINDOW_DAYS` (기본 7)
- `RELATED_TICKER_WEIGHT` (기본 0.2)
- `RELATED_FRESHNESS_WEIGHT` (기본 0.001 per hour)
- `RELATED_CACHE_TTL_SECONDS` (기본 60) 메모리 캐시 TTL
