# [CH-1] WebSocket 스트리밍 연동 및 비용 가드

## Problem 1-Pager
- 배경: WebSocket 채팅이 OpenAI 스트리밍과 연결됐지만 비용/시간 가드, 에러 매핑, 컨텍스트 캐시가 없어 장애·과금 리스크가 있다.
- 문제: (1) 비용 상한 초과/키 미설정 시 서버 예외로 종료, (2) 타임아웃·429 재시도 정책 부재, (3) 컨텍스트 캐시 미사용으로 매 요청 DB 조회 및 히스토리 10개 한정, (4) 클라이언트가 오류/지연을 명확히 알 수 없다.
- 목표: WebSocket ↔ OpenAI 스트리밍 경로에 비용·시간 가드와 에러 매핑을 추가하고, 리포트 요약+최근 20개 히스토리 컨텍스트를 캐시·전달해 안정적으로 스트리밍한다.
- 비목표: SSE 폴백 결정/구현, Slack 연동, 인증·권한 고도화, Vector/RAG 통합.
- 제약: 요청당 비용 $0.02 이하, 첫 청크 <2초, 파일≤300LOC/함수≤50LOC, 민감정보 미로깅, 테스트 추가(성공·실패 경로).

## 대안 비교
- Option A: 사전 추정 기반 가드(프롬프트 길이+max_tokens로 비용/시간 한도 계산 후 차단) — 장점: 즉시 실패로 과금 차단, 단점: 추정 오차 가능, 위험: 과도 차단. **선택**: 안전성/단순성.
- Option B: 사후 usage 기반 가드(스트리밍 완료 후 usage 조회/추정) — 장점: 실제 비용 기준, 단점: 스트리밍 중 초과 감지 어려움, 위험: 초과 과금. 후속 보완으로 고려.

## 범위/비범위
- 포함: OpenAIClient 스트리밍 가드/에러 타입 정교화, ChatService 컨텍스트 캐시+20개 히스토리, WebSocket 에러 매핑/빈 입력 처리, 프론트 에러/지연 배너·전송 상태.
- 제외: SSE 폴백, 슬랙/알림 통합, 인증 미들웨어, Vector 검색.

## 수용 기준
- happy-path: 첫 청크 <2초, 스트리밍 완료 후 메시지 DB 저장.
- 오류: 빈 입력/키 누락/비용 상한/타임아웃/429 재시도 후 실패 시 명시적 에러 코드·메시지 전송, 서버는 계속 동작.
- 문맥: 리포트 요약 + 최근 20개 메시지 사용, 캐시(있으면) 후 DB fallback.

## 테스트
- 단위: OpenAIClient 스트리밍 비용 가드/타임아웃/429 재시도, ChatService 빈 입력/세션 없음/정상 스트리밍.
- 통합: WebSocket 메시지→청크 수신→done/error 흐름, 비용 초과/타임아웃 경로.
- 프론트: 에러 배너/지연 안내, 전송 중 버튼 비활성.

## 리스크/의존성
- OPENAI_API_KEY/Redis 미설정 시 기능 제한 → 명시적 에러/캐시 폴백.
- 비용 추정 오차로 과도 차단 가능 → 상한/토큰 계산을 보수적으로 설정.
- 재연결 중 중복 메시지 가능 → 서버·클라이언트에서 latest id/append 로직 점검.
