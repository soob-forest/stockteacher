# [CH-3] 환경 기반 WebSocket URL, 연결 상태/지연 배너, SSE 폴백 결정

## Problem 1-Pager
- 배경: WebSocket 스트리밍이 붙었지만 로컬/배포 URL이 하드코딩되어 있고, 연결/재연결/지연 안내가 단순해 운영 환경 변화나 프록시 차단 시 사용자가 혼란스러울 수 있다. SSE 폴백 여부도 미정이라 방화벽 환경 대응 계획이 부족하다.
- 문제: (1) `ws://localhost:8000` 고정 URL로 배포 환경에서 실패, (2) 재연결/지연 상태를 명확히 알리는 배너/UI 부족, (3) WebSocket 차단 시 대비책(SSE 여부) 미정.
- 목표: 환경 변수 기반으로 ws/wss URL을 구성하고, 연결/재시도/지연 상태를 UI로 안내하며, SSE 폴백 적용 여부를 결정·토글로 반영한다.
- 비목표: 인증/권한, 모바일/다국어 UX, Slack 연동, SSE 서버 구현의 고도화(최소 폴백 여부 결정만 포함).
- 제약: 파일≤300LOC·함수≤50LOC, 민감정보 미로그, 요청당 비용 상한 유지, 새 코드에 테스트 추가.

## 대안 비교
- URL 구성
  - Option A: 클라이언트에서 `NEXT_PUBLIC_WS_BASE` 환경 변수 + 프로토콜 자동 결정(ws/wss) — 장점: 단순, 배포별 설정 용이. 단점: 설정 누락 시 오류. **선택**
  - Option B: 서버에서 WebSocket URL 조회 API 제공 — 장점: 클라이언트 설정 최소화. 단점: API 추가/캐시 필요. 보류.
- 폴백 전략
  - Option A: WebSocket만 사용, 실패 시 에러 안내 — 장점: 구현 단순. 단점: 방화벽 환경에서 사용 불가. 위험: 사용성 저하.
  - Option B: 읽기 전용 SSE 폴백 — 장점: 프록시 호환성↑. 단점: 추가 엔드포인트/클라이언트 구현 필요.
  - **선택**: Option A 우선, 환경 플래그로 SSE 폴백 옵트인 가능하도록 토글 추가.

## 범위/비범위
- 포함: 환경 변수 기반 WS URL 설정, 연결/재연결/지연 배너 및 에러 메시지 개선, SSE 폴백 여부/토글 결정 및 TODO 명시, 기본 테스트 보강.
- 제외: 실제 SSE 엔드포인트/클라이언트 구현(토글만), 인증/역할.

## 수용 기준
- 로컬/배포 환경에 따라 ws/wss URL이 올바르게 설정되고 콘솔 경고 없이 연결된다.
- 연결 실패/재연결/지연 시 사용자에게 배너(또는 명확한 메시지)로 안내된다.
- SSE 폴백 결정이 문서화/플래그화되어 WebSocket 차단 시의 행동이 명확하다.

## 테스트
- 단위/통합: URL 빌더 함수 테스트, WebSocket 훅 상태 전이(연결/재연결/지연/에러) 테스트, SSE 폴백 토글 값 반영 확인.
- 수동/E2E: 환경 변수로 ws/wss 전환 후 연결 확인, 네트워크 차단 시 에러 배너 노출 확인.

## 리스크/의존성
- 환경 변수 누락 시 연결 실패 → 기본값/에러 배너로 노출.
- SSE 폴백 미구현 시 일부 네트워크에서 사용 불가 → 플래그로 기대치 관리.
- 재연결 중 중복 메시지 가능성 → 기존 메시지 병합 로직 재확인 필요.
