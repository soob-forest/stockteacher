# 기능 보완 계획 (시니어 PM 뷰)

## Problem 1-Pager
- 배경: 뉴스/공시를 수집·요약해 웹/채팅으로 전달하는 MVP가 베타 상태. 채팅은 하드코딩 응답, 알림/품질 가드/탐색 기능 미흡.
- 문제: 사용자가 “왜 여기서 리포트를 봐야 하는가?”에 답하지 못함. 맥락 있는 대화·알림·품질·검색이 부재해 DAU·전환을 끌어올릴 수 없음.
- 목표: 2스프린트(≈4주) 내 “리포트 품질이 보장되고, 실시간 알림·대화가 유용하다”는 최소 경험 제공.
- 비목표: Slack 봇, Vector DB 통합, 다국어/모바일 앱, 주간/월간 대시보드는 이번 범위 밖.
- 제약: OpenAI/NewsAPI 비용 상한(요청당 $0.02), Redis/DB 의존, 웹/백엔드 분리 배포, 파일 ≤300LOC·함수 ≤50LOC 규칙.

## 핵심 지표
- 채팅 응답 만족도(피드백) ≥4.0/5.0
- 리포트 열람→채팅 전환율 ≥30%
- 리포트 생성→게시 소요 p95 < 10분
- 잘못된 리포트 롤백/숨김까지 걸린 시간 < 15분

## 우선 실행 워크스트림 (다음 2스프린트)

1) **채팅 가치화 & 실시간성**
   - LLM 통합: WebSocket/SSE 경로에 OpenAI 스트리밍 연결, 요약+소스 기반 시스템 프롬프트 구성, 비용 가드(초과 시 축약 응답).
   - 대화 상태: 세션 컨텍스트 캐시(최신 20개 메시지 + 리포트 메타), 초기 메시지 히스토리 로드.
   - UX: WebSocket URL을 환경 기반(ws/wss), 연결 상태/재시도/지연 안내, 부분 응답 표시.
   - 테스트: WebSocket 통합, 실패 경로(SSE 폴백 또는 오류 배너) E2E.

2) **알림/구독 품질**
   - 알림 정책: 알림 시간대/빈도/채널(웹 푸시→이메일 순) 선택 UI 및 API.
   - 중요도 라우팅: 이상 점수/감성 임계치 기반 “긴급” 플래그 → 푸시 우선, 일반은 일괄 묶음.
   - 구독 온보딩: 추천 구독 프리셋(섹터별) + 기본 알림 템플릿.

3) **품질 가드 & 운영**
   - 리뷰 큐: 리포트 상태(대기/게시/숨김)와 롤백 버튼, 실패/지연 표시.
   - 자동 점검: 규칙 기반 경고(감성 극단, 키워드 공백, JSON 파싱 누락) → 대기 큐로 전환.
   - 가시성: 파이프라인 상태 보드(collect/analyze/publish)와 SLA 타이머, 채팅 장애 배너.

4) **탐색/발견**
   - 검색 필터 확장: 티커+키워드+날짜 범위+감성, 즐겨찾기/긴급 필터.
   - 추천 섹션: 리포트 상세에 “관련 리포트(최근 7일 같은 티커·유사 키워드)” 최소 구현. Vector DB 없이 키워드/티커 교집합으로 시작.

## 주요 결정 대안 (선택 제안 포함)
- 채팅 전송: WebSocket(현재) vs SSE 폴백
  - 장점: WebSocket 양방향/지연↓, SSE는 방화벽 우회 쉬움
  - 단점: WebSocket 프록시/인증 설정 필요, SSE는 역방향 메시지 불가
  - 제안: 기본 WebSocket + SSE 읽기 전용 폴백(프록시 제한 대비)
- 알림 채널: 웹 푸시 vs 이메일(링크)
  - 장점: 푸시는 즉시성, 이메일은 도달률/추적 용이
  - 단점: 푸시는 브라우저 퍼미션/HTTPS 필수, 이메일은 즉시성↓
  - 제안: 1차 이메일 요약(“일일 리포트”) + 웹 푸시 파일럿(긴급 플래그만)
- 리포트 품질 가드: 자동 룰 vs 휴먼 리뷰
  - 장점: 자동 룰은 빠르고 비용↓, 휴먼은 정확도↑
  - 단점: 룰 오탐 가능, 휴먼은 인력/지연↑
  - 제안: 룰 기반 “대기” 큐 + 필요 시 1차 휴먼 승인(5분 SLA)로 병행

## 리스크/가정
- OPENAI_API_KEY 미설정 시 채팅 다운: 기능 토글/대체 응답 필요.
- Redis/푸시 인프라 부재 시 캐시/알림 기능 일부 축소될 수 있음.
- 데이터 품질(뉴스API) 편향 시 이상 점수/감성 기준이 왜곡될 수 있음 → 설정 가능 임계치 필요.

## 성공 조건 체크리스트
- 채팅: 스트리밍 정상, 비용 상한 초과 시 축약/오류 메시지 노출, 재연결 3회 시도 후 폴백.
- 알림: 사용자가 알림 창구/시간대를 제어, 긴급 알림은 5분 내 발송.
- 품질: 실패/대기 리포트가 목록에 표기되고, 클릭 한 번으로 숨김/재시도.
- 검색/추천: 상세 화면에서 최소 3개 관련 리포트 노출(없을 시 빈 상태 안내).

## 워크스트림별 실행 티켓 (초안)
- 채팅 가치화 & 실시간성
  - CH-1: WebSocket → OpenAI 스트리밍 연결, 비용 상한 초과 시 축약/에러 메시지 반환. 완료 기준: happy-path/timeout/limit 초과 E2E.
  - CH-2: 초기 메시지 히스토리 로드 + 세션 컨텍스트 캐시(최근 20개) 적용. 완료 기준: 재접속 시 마지막 20개 메시지 표시.
  - CH-3: 환경 기반 ws/wss URL, 재연결·지연 배너 UI, SSE 폴백 여부 결정. 완료 기준: 로컬/배포 환경에서 URL 오동작 없고 에러 시 사용자 안내.
- 알림/구독 품질
  - AL-1: 알림 정책 API/UI(시간대·빈도·채널 선택) 설계/구현. 완료 기준: 사용자별 정책 저장·조회, 기본값 존재.
  - AL-2: 긴급 플래그 라우팅(이상/감성 임계치) → 푸시/이메일 전송 흐름 정의 및 PoC. 완료 기준: 긴급 테스트 데이터로 즉시 알림 전송.
  - AL-3: 온보딩 프리셋(섹터별 추천 구독 + 기본 알림) 노출. 완료 기준: 신규 사용자 3클릭 이내 기본 세트 활성화.
- 품질 가드 & 운영
  - QO-1: 리포트 상태 플래그(대기/게시/숨김)와 롤백 버튼. 완료 기준: 잘못된 리포트 숨김 후 목록/상세에서 제외.
  - QO-2: 자동 점검 룰(감성 극단/키워드 공백/JSON 누락) → 대기 큐 전환, 경고 표시. 완료 기준: 룰 매칭 시 사용자에게 “검토 중” 배지 노출.
  - QO-3: 파이프라인 상태 보드(collect/analyze/publish SLA 타이머) + 채팅 장애 배너. 완료 기준: 단계별 최신 실행 상태와 지연 표시.
- 탐색/발견
  - DS-1: 검색 필터 확장(티커+키워드+날짜 범위+감성, 즐겨찾기/긴급 토글). 완료 기준: 조합 필터로 결과 집합 변동 확인.
  - DS-2: 관련 리포트 추천(최근 7일, 티커/키워드 교집합). 완료 기준: 상세 화면에 최소 0~3개 카드 노출, 없을 때 빈 상태 안내.
  - DS-3: 검색/추천 피드백 로깅(클릭/무시 이벤트). 완료 기준: 기본 로그에 이벤트 수집, 향후 개선 데이터 확보.

## 바로 실행할 이슈(우선순위/순서)
1) CH-1: WebSocket ↔ OpenAI 스트리밍 연동 + 비용 가드/에러 핸들링
2) CH-2: 세션 히스토리 로드 + 컨텍스트 캐시(최근 20개) 적용
3) CH-3: 환경 기반 ws/wss URL, 연결 상태/재시도/지연 배너, SSE 폴백 결정
4) QO-1: 리포트 상태 플래그 + 롤백/숨김 버튼(게시/목록 반영)
5) QO-2: 자동 점검 룰(감성 극단/키워드 공백/JSON 누락) → 대기 큐 + “검토 중” 배지
6) AL-1: 알림 정책 API/UI(시간대·빈도·채널) 저장/조회 ✅
7) AL-2: 긴급 플래그 라우팅(이상/감성 임계치) → 푸시/이메일 PoC ✅
8) DS-1: 검색 필터 확장(티커+키워드+날짜 범위+감성, 즐겨찾기/긴급 토글)
9) DS-2: 관련 리포트 추천(티커/키워드 교집합) 상세 카드 노출

## 실행용 To-Do 체크리스트
- [x] CH-1: WebSocket ↔ OpenAI 스트리밍 연동, 비용 가드/에러 핸들링
- [x] CH-2: 세션 히스토리 로드 + 컨텍스트 캐시(최근 20개)
- [x] CH-3: 환경 기반 ws/wss URL, 연결 상태/재시도/지연 배너, SSE 폴백 여부
- [x] QO-1: 리포트 상태 플래그(대기/게시/숨김) + 롤백/숨김 버튼, 목록/상세 반영
- [x] QO-2: 자동 점검 룰(감성 극단/키워드 공백/JSON 누락) → 대기 큐 + “검토 중” 배지
- [x] AL-1: 알림 정책 API/UI(시간대·빈도·채널) 저장/조회
- [x] AL-2: 긴급 플래그 라우팅(이상/감성 임계치) → 푸시/이메일 PoC
- [x] DS-1: 검색 필터 확장(티커+키워드+날짜 범위+감성, 즐겨찾기/긴급 토글)
- [ ] DS-2: 관련 리포트 추천(티커/키워드 교집합) 상세 카드 노출

## 이슈 생성 시 필수 템플릿(요약)
- 제목: `[CH-1] WebSocket 스트리밍 연동 및 비용 가드`
- 배경/문제: (현재 동작/결핍 요약)
- 목표/결과물: (완료 기준 그대로)
- 범위/비범위: (예: 슬랙 알림 제외)
- 수용 기준: (happy-path, 오류/타임아웃, 비용 초과 시 메시지)
- 테스트: (단위/통합/E2E 항목)
- 의존성/리스크: (OpenAI 키, Redis 여부 등)
